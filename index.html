<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Builder v70 Ultimate Edition</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Pacifico&family=Ruslan+Display&family=Montserrat:wght@600;800&family=Press+Start+2P&family=Lobster&family=Comfortaa:wght@700&display=swap" rel="stylesheet">
<style>
/* --- –î–ò–ó–ê–ô–ù –†–ï–î–ê–ö–¢–û–†–ê (–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) --- */
:root { --primary: #6c5ce7; --bg-editor: #f4f7f6; --card-bg: #ffffff; --text-main: #2d3436; --text-muted: #636e72; --gradient: linear-gradient(135deg, #6c5ce7, #a29bfe); --panel-w: 430px; }
* { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
body { font-family: 'Roboto', sans-serif; height: 100vh; display: flex; overflow: hidden; background: #dfe6e9; }
.editor-panel { width: var(--panel-w); background: var(--bg-editor); border-right: 1px solid #dcdde1; display: flex; flex-direction: column; z-index: 10; box-shadow: 5px 0 15px rgba(0,0,0,0.05); }
.editor-header { padding: 20px; background: var(--gradient); color: #fff; box-shadow: 0 4px 10px rgba(108, 92, 231, 0.3); position: relative; }
.editor-header h2 { font-family: 'Montserrat', sans-serif; font-size: 15px; margin: 0; font-weight: 800; letter-spacing: 0.5px; text-transform: uppercase; display: flex; align-items: center; gap: 10px; }
.header-actions { position: absolute; top: 8px; right: 15px; display: flex; gap: 5px; }
.icon-btn { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: #fff; width: 32px; height: 32px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; transition: 0.2s; }
.icon-btn:hover { background: rgba(255,255,255,0.3); transform: scale(1.05); }
.tabs { display: flex; background: #fff; padding: 0 10px; border-bottom: 1px solid #e0e0e0; }
.tab { flex: 1; text-align: center; padding: 15px 0; color: var(--text-muted); cursor: pointer; font-size: 11px; font-weight: 600; border-bottom: 3px solid transparent; transition: 0.3s; text-transform: uppercase; }
.tab:hover { color: var(--primary); background: #fdfdfd; }
.tab.active { color: var(--primary); border-bottom-color: var(--primary); }
.settings-content { flex: 1; overflow-y: auto; padding: 20px; }
.section { display: none; animation: fadeIn 0.3s; }
.section.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
.info-box { background: #e3f2fd; border-left: 4px solid #2196f3; color: #0d47a1; padding: 12px; border-radius: 4px; font-size: 12px; margin-bottom: 20px; line-height: 1.4; }
.form-group { margin-bottom: 15px; }
.form-group label { display: block; font-size: 11px; font-weight: 700; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
.file-upload-row { display: flex; gap: 5px; }
.file-upload-row input[type="text"] { flex: 1; border-top-right-radius: 0; border-bottom-right-radius: 0; }
input[type="file"] { display: none; }
.btn-upload { background: #dfe6e9; border: 2px solid #e6e6e6; border-left: none; border-top-right-radius: 8px; border-bottom-right-radius: 8px; padding: 0 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 15px; transition: 0.2s; }
.btn-play { background: #27ae60; border: 2px solid #27ae60; border-left: none; color: #fff; border-radius: 0; padding: 0 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; transition: 0.2s; }
.file-upload-row .btn-play { border-top-right-radius: 8px; border-bottom-right-radius: 8px; }
.form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px 12px; border: 2px solid #e6e6e6; border-radius: 8px; font-size: 14px; background: #fff; color: var(--text-main); transition: 0.2s; font-family: 'Roboto', sans-serif; }
.form-group input:focus, .form-group textarea:focus, .form-group select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.1); }
.form-group input[type="color"] { height: 40px; padding: 2px; cursor: pointer; }
.form-group input[type="range"] { cursor: pointer; }
.form-group input[type="checkbox"] { width: auto; margin-right: 8px; }
.form-row { display: flex; gap: 10px; }
.editor-footer { padding: 20px; border-top: 1px solid #e0e0e0; background: #fff; display: flex; gap: 10px;}
.btn-generate { flex: 1; padding: 14px; background: var(--gradient); color: #fff; border: none; border-radius: 10px; font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 5px 15px rgba(108, 92, 231, 0.4); transition: 0.2s; }
.btn-publish { flex: 1; padding: 14px; background: linear-gradient(135deg, #00b894, #00cec9); color: #fff; border: none; border-radius: 10px; font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 5px 15px rgba(0, 184, 148, 0.4); transition: 0.2s; }
.btn-generate:hover, .btn-publish:hover { transform: translateY(-2px); }
.preview-area { flex: 1; background: #dfe6e9; padding: 20px; display: flex; align-items: center; justify-content: center; background-image: radial-gradient(#b2bec3 1px, transparent 1px); background-size: 20px 20px; }
#game-preview-container { width: 960px; height: 540px; background: #fff; box-shadow: 0 20px 60px rgba(0,0,0,0.15); border-radius: 12px; overflow: hidden; }
#game-frame { width: 100%; height: 100%; border: none; }
.modal-overlay { position: fixed; inset: 0; background: rgba(45, 52, 54, 0.9); z-index: 1000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
.code-modal { background: #fff; padding: 30px; border-radius: 16px; width: 600px; max-width: 90%; display: flex; flex-direction: column; gap: 15px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
.code-modal textarea { width: 100%; height: 300px; font-family: 'Consolas', monospace; padding: 15px; font-size: 12px; background: #f1f2f6; border: none; border-radius: 8px; color: #2f3542; }
.modal-btns { display: flex; justify-content: flex-end; gap: 10px; }
.modal-btns button { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
.btn-close { background: #dfe4ea; color: #2f3542; }
.btn-copy { background: var(--primary); color: #fff; }
.style-section { background: #fff; border: 2px solid #e6e6e6; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
.style-section-title { font-size: 12px; font-weight: 800; color: var(--primary); margin-bottom: 12px; text-transform: uppercase; display: flex; align-items: center; gap: 8px; border-bottom: 2px solid #f0f0f0; padding-bottom: 8px; }
.checkbox-group { display: flex; align-items: center; padding: 8px 0; }
.sound-item { background: #f8f9fa; border: 1px solid #e0e0e0; padding: 12px; border-radius: 8px; margin-bottom: 10px; }
.sound-item-title { font-size: 11px; font-weight: 700; color: var(--primary); margin-bottom: 8px; text-transform: uppercase; }
.range-value { display: inline-block; min-width: 40px; text-align: center; font-weight: 700; color: var(--primary); }
</style>
</head>
<body>

<div class="editor-panel">
    <div class="editor-header">
        <h2>–†–µ–¥–∞–∫—Ç–æ—Ä "–ü–æ–π–º–∞–π –ø—Ä–µ–¥–º–µ—Ç"</h2>
        <div class="header-actions">
            <button class="icon-btn" onclick="resetAll()" title="–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë">üîÑ</button>
        </div>
    </div>
    <div class="tabs">
        <div class="tab active" onclick="switchTab('content')">–í–æ–ø—Ä–æ—Å—ã</div>
        <div class="tab" onclick="switchTab('graphics')">–ì—Ä–∞—Ñ–∏–∫–∞</div>
        <div class="tab" onclick="switchTab('style')">–°—Ç–∏–ª—å</div>
        <div class="tab" onclick="switchTab('text')">–¢–µ–∫—Å—Ç—ã</div>
        <div class="tab" onclick="switchTab('sounds')">–ó–≤—É–∫–∏</div>
        <div class="tab" onclick="switchTab('game')">–ò–≥—Ä–∞</div>
    </div>
    
    <div class="settings-content">
        <div id="tab-content" class="section active">
            <div class="form-group"><label>üìù –í–æ–ø—Ä–æ—Å—ã</label><textarea id="bulk-questions" rows="4" oninput="debouncedUpdate()"></textarea></div>
            <div class="form-group"><label>‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã</label><textarea id="bulk-correct" rows="4" oninput="debouncedUpdate()"></textarea></div>
            <div class="form-group"><label>‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã</label><textarea id="bulk-wrong" rows="4" oninput="debouncedUpdate()"></textarea></div>
        </div>
        
        <div id="tab-graphics" class="section">
            <div class="form-group"><label>–ì–µ—Ä–æ–π</label><div class="file-upload-row"><input type="text" id="img-hero" oninput="clearCache('hero'); debouncedUpdate()"><label for="file-hero" class="btn-upload">üìÇ</label><input type="file" id="file-hero" accept="image/*" onchange="encodeImg(this, 'hero')"></div></div>
            <div class="form-group"><label>–ë–æ–º–±–∞</label><div class="file-upload-row"><input type="text" id="img-bomb" oninput="clearCache('bomb'); debouncedUpdate()"><label for="file-bomb" class="btn-upload">üìÇ</label><input type="file" id="file-bomb" accept="image/*" onchange="encodeImg(this, 'bomb')"></div></div>
            <div class="form-group"><label>–ñ–∏–∑–Ω—å</label><div class="file-upload-row"><input type="text" id="img-life" oninput="clearCache('life'); debouncedUpdate()"><label for="file-life" class="btn-upload">üìÇ</label><input type="file" id="file-life" accept="image/*" onchange="encodeImg(this, 'life')"></div></div>
            <div class="form-group"><label>–ë–æ–Ω—É—Å</label><div class="file-upload-row"><input type="text" id="img-bonus-score" oninput="clearCache('bscore'); debouncedUpdate()"><label for="file-bonus-score" class="btn-upload">üìÇ</label><input type="file" id="file-bonus-score" accept="image/*" onchange="encodeImg(this, 'bscore')"></div></div>
            <div class="form-row">
                <div class="form-group"><label>–°–∫–∏–Ω 1</label><div class="file-upload-row"><input type="text" id="img-skin1" oninput="clearCache('skin1'); debouncedUpdate()"><label for="file-skin1" class="btn-upload">üìÇ</label><input type="file" id="file-skin1" accept="image/*" onchange="encodeImg(this, 'skin1')"></div></div>
                <div class="form-group"><label>–°–∫–∏–Ω 2</label><div class="file-upload-row"><input type="text" id="img-skin2" oninput="clearCache('skin2'); debouncedUpdate()"><label for="file-skin2" class="btn-upload">üìÇ</label><input type="file" id="file-skin2" accept="image/*" onchange="encodeImg(this, 'skin2')"></div></div>
            </div>
        </div>

        <div id="tab-style" class="section">
            <div class="style-section">
                <div class="form-group"><label>–®—Ä–∏—Ñ—Ç</label><select id="font-family" onchange="u()"><option value="Ruslan Display">Ruslan Display</option><option value="Roboto">Roboto</option><option value="Press Start 2P">Pixel</option></select></div>
                <div class="form-row"><div class="form-group"><label>–í–æ–ø—Ä–æ—Å (px)</label><input type="number" id="fs-q" value="28" onchange="u()"></div><div class="form-group"><label>–û—Ç–≤–µ—Ç (px)</label><input type="number" id="fs-a" value="20" onchange="u()"></div></div>
            </div>
            <div class="style-section">
                <div class="form-group"><label>–†–∞–∑–º–µ—Ä –≥–µ—Ä–æ—è</label><input type="range" id="conf-hero-size" min="50" max="250" value="150" oninput="u()"></div>
                <div class="form-group"><label>–†–∞–∑–º–µ—Ä –æ—Ç–≤–µ—Ç–æ–≤</label><input type="range" id="conf-size" min="40" max="150" value="70" oninput="u()"></div>
                <div class="form-group"><label>–†–∞–∑–º–µ—Ä –±–æ–º–±</label><input type="range" id="conf-bomb-size" min="40" max="150" value="60" oninput="u()"></div>
                <div class="form-group"><label>–°–º–µ—â–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞</label><input type="range" id="conf-tpos" min="-50" max="50" value="0" oninput="u()"></div>
            </div>
            <div class="style-section">
                <div class="form-group"><label>–§–æ–Ω –æ–∫–Ω–∞</label><input type="color" id="col-win-bg" value="#1a1a1a" onchange="u()"></div>
                <div class="form-group"><label>–¢–µ–∫—Å—Ç –æ–∫–Ω–∞</label><input type="color" id="col-win-text" value="#ffffff" onchange="u()"></div>
                <div class="form-group"><label>–†–∞–º–∫–∞/–ö–Ω–æ–ø–∫–∏</label><input type="color" id="col-border" value="#a29bfe" onchange="u()"></div>
                <div class="checkbox-group"><input type="checkbox" id="win-glow" checked onchange="u()"><label for="win-glow">–°–≤–µ—á–µ–Ω–∏–µ</label></div>
            </div>
            <div class="style-section">
                <div class="form-row"><div class="form-group"><label>–ì—Ä–∞–¥–∏–µ–Ω—Ç 1</label><input type="color" id="col-p1" value="#9b59b6" onchange="u()"></div><div class="form-group"><label>–ì—Ä–∞–¥–∏–µ–Ω—Ç 2</label><input type="color" id="col-p2" value="#8e44ad" onchange="u()"></div></div>
            </div>
            <div class="style-section">
                <div class="form-group"><label>–§–æ–Ω –≤–æ–ø—Ä–æ—Å–∞</label><input type="color" id="col-qbox-bg" value="#111111" onchange="u()"></div>
                <div class="form-group"><label>–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞</label><input type="color" id="col-question-text" value="#ffffff" onchange="u()"></div>
            </div>
            <div class="style-section">
                <div class="form-row"><div class="form-group"><label>–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞</label><input type="color" id="col-lt" value="#ffffff" onchange="u()"></div><div class="form-group"><label>–§–æ–Ω –æ—Ç–≤–µ—Ç–∞</label><input type="color" id="col-lb" value="#000000" onchange="u()"></div></div>
                <div class="checkbox-group"><input type="checkbox" id="item-transparent" onchange="u()"><label for="item-transparent">–ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω</label></div>
            </div>
        </div>

        <div id="tab-text" class="section">
            <div class="form-group"><label>–Ø–∑—ã–∫</label><select id="lang-preset" onchange="applyLangPreset()"><option value="ru">RU</option><option value="en">EN</option></select></div>
            <div class="form-group"><label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label><input type="text" id="tt" value="–ü–û–ô–ú–ê–ô –ü–†–ï–î–ú–ï–¢–´" onchange="u()"></div>
            <div class="form-group"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="td" rows="2" onchange="u()">–ò—Å–ø–æ–ª—å–∑—É–π ‚Üê –∏–ª–∏ ‚Üí</textarea></div>
            <div class="form-group"><label>–ü–æ–±–µ–¥–∞</label><input type="text" id="tw" value="–ü–û–ë–ï–î–ê!" onchange="u()"></div>
            <div class="form-group"><label>–ü–æ—Ä–∞–∂–µ–Ω–∏–µ</label><input type="text" id="tl" value="–û–π!" onchange="u()"></div>
            <div class="form-group"><label>–ö–Ω–æ–ø–∫–∞ –°—Ç–∞—Ä—Ç</label><input type="text" id="btn-start" value="–ò–ì–†–ê–¢–¨" onchange="u()"></div>
            <div class="form-group"><label>–ö–Ω–æ–ø–∫–∞ –î–∞–ª–µ–µ</label><input type="text" id="btn-continue" value="–ü–†–û–î–û–õ–ñ–ò–¢–¨" onchange="u()"></div>
            <div class="form-group"><label>–ö–Ω–æ–ø–∫–∞ –ï—â–µ —Ä–∞–∑</label><input type="text" id="btn-retry" value="–ï–©–Å –†–ê–ó" onchange="u()"></div>
        </div>

        <div id="tab-sounds" class="section">
            <div class="sound-item"><label>–ë–æ–º–±–∞</label><div class="file-upload-row"><input type="text" id="snd-bomb" oninput="debouncedUpdate()"><input type="file" id="file-snd-bomb" accept="audio/*" onchange="encodeAudio(this, 'sndbomb')"></div></div>
            <div class="sound-item"><label>–ü—Ä–∞–≤–∏–ª—å–Ω–æ</label><div class="file-upload-row"><input type="text" id="snd-correct" oninput="debouncedUpdate()"><input type="file" id="file-snd-correct" accept="audio/*" onchange="encodeAudio(this, 'sndcorrect')"></div></div>
            <div class="sound-item"><label>–û—à–∏–±–∫–∞</label><div class="file-upload-row"><input type="text" id="snd-wrong" oninput="debouncedUpdate()"><input type="file" id="file-snd-wrong" accept="audio/*" onchange="encodeAudio(this, 'sndwrong')"></div></div>
            <div class="sound-item"><label>–ñ–∏–∑–Ω—å</label><div class="file-upload-row"><input type="text" id="snd-life" oninput="debouncedUpdate()"><input type="file" id="file-snd-life" accept="audio/*" onchange="encodeAudio(this, 'sndlife')"></div></div>
            <div class="sound-item"><label>–ë–æ–Ω—É—Å</label><div class="file-upload-row"><input type="text" id="snd-bonus" oninput="debouncedUpdate()"><input type="file" id="file-snd-bonus" accept="audio/*" onchange="encodeAudio(this, 'sndbonus')"></div></div>
            <div class="sound-item"><label>–ü–æ–±–µ–¥–∞</label><div class="file-upload-row"><input type="text" id="snd-win" oninput="debouncedUpdate()"><input type="file" id="file-snd-win" accept="audio/*" onchange="encodeAudio(this, 'sndwin')"></div></div>
            <div class="sound-item"><label>–ü–æ—Ä–∞–∂–µ–Ω–∏–µ</label><div class="file-upload-row"><input type="text" id="snd-lose" oninput="debouncedUpdate()"><input type="file" id="file-snd-lose" accept="audio/*" onchange="encodeAudio(this, 'sndlose')"></div></div>
        </div>

        <div id="tab-game" class="section">
             <div class="form-group"><label>–°–∫–æ—Ä–æ—Å—Ç—å</label><input type="range" id="conf-speed" min="1" max="10" step="0.5" value="2" oninput="u()"></div>
             <div class="form-group"><label>–ß–∞—Å—Ç–æ—Ç–∞</label><input type="range" id="conf-freq" min="300" max="2000" step="100" value="900" oninput="u()"></div>
             <div class="form-group"><label>–ñ–∏–∑–Ω–∏</label><input type="range" id="conf-lives" min="1" max="10" step="1" value="3" oninput="u()"></div>
             <div class="form-group"><label>–®–∞–Ω—Å –±–æ–º–±—ã %</label><input type="range" id="prob-bomb" min="0" max="50" value="15" oninput="u()"></div>
             <div class="form-group"><label>–®–∞–Ω—Å –∂–∏–∑–Ω–∏ %</label><input type="range" id="prob-life" min="0" max="30" value="5" oninput="u()"></div>
             <div class="form-group"><label>–®–∞–Ω—Å –±–æ–Ω—É—Å–∞ %</label><input type="range" id="prob-score" min="0" max="30" value="5" oninput="u()"></div>
             <div class="checkbox-group"><input type="checkbox" id="mobile-controls" checked onchange="u()"><label for="mobile-controls">–ú–æ–±. –∫–Ω–æ–ø–∫–∏</label></div>
        </div>
    </div>
    
    <div class="editor-footer">
        <button class="btn-publish" onclick="publishGame()">‚òÅÔ∏è –û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨</button>
        <button class="btn-generate" onclick="gen()">üöÄ –ü–û–õ–£–ß–ò–¢–¨ –ö–û–î</button>
    </div>
</div>
<div class="preview-area"><div id="game-preview-container"><iframe id="game-frame"></iframe></div></div>
<div id="modal-code" class="modal-overlay"><div class="code-modal"><h3>üéâ –ì–æ—Ç–æ–≤–æ!</h3><p>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤ Genially (Insert -> Others).</p><textarea id="final-code" readonly></textarea><div class="modal-btns"><button class="btn-close" onclick="document.getElementById('modal-code').style.display='none'">–ó–∞–∫—Ä—ã—Ç—å</button><button class="btn-copy" onclick="copy()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button></div></div></div>

<script>
// –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
const def={h:"https://img.genially.com/684ea2da1b51060014c50e97/4e2c4c8a-5a17-4c32-95e1-7cc360b44a84.png",b:"https://img.genially.com/684ea2da1b51060014c50e97/91910846-d855-4c4b-8561-5ff0edaa87ad.png",l:"https://img.genially.com/684ea2da1b51060014c50e97/56159391-2288-48d7-8264-2e7f0aa2f799.gif",sk1:"https://img.genially.com/684ea2da1b51060014c50e97/33b8d640-53fd-4b63-b5df-f7df01a72b2f.png",sk2:"https://img.genially.com/684ea2da1b51060014c50e97/5857090c-baea-4b09-bb56-cda2472b1b19.png",bscore:"https://img.genially.com/684ea2da1b51060014c50e97/516bf8aa-cb50-433c-98ed-500cc8bb4696.png"};

// –Ø–∑—ã–∫–∏
const langPresets = {
    ru: { title: "–ü–û–ô–ú–ê–ô –ü–†–ï–î–ú–ï–¢–´", desc: "–ò—Å–ø–æ–ª—å–∑—É–π ‚Üê –∏–ª–∏ ‚Üí —á—Ç–æ–±—ã –ø–æ–π–º–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã.", win: "–ü–û–ë–ï–î–ê!", lose: "–û–π!", btnStart: "–ò–ì–†–ê–¢–¨", btnContinue: "–ü–†–û–î–û–õ–ñ–ò–¢–¨", btnRetry: "–ï–©–Å –†–ê–ó" },
    en: { title: "CATCH THE ITEMS", desc: "Use ‚Üê or ‚Üí to catch correct answers.", win: "VICTORY!", lose: "Oops!", btnStart: "PLAY", btnContinue: "CONTINUE", btnRetry: "TRY AGAIN" }
};

let imgCache = {};
let audioCache = {};
let updateTimeout = null;

function debouncedUpdate() { clearTimeout(updateTimeout); updateTimeout = setTimeout(() => { u(); }, 300); }

window.onload=()=>{
    // Init values
    document.getElementById('img-hero').value=def.h; document.getElementById('img-bomb').value=def.b; document.getElementById('img-life').value=def.l; document.getElementById('img-skin1').value=def.sk1; document.getElementById('img-skin2').value=def.sk2; document.getElementById('img-bonus-score').value=def.bscore;
    document.getElementById('bulk-questions').value = "–°—Ç–æ–ª–∏—Ü–∞ –†–æ—Å—Å–∏–∏?\n2+2=?";
    document.getElementById('bulk-correct').value = "–ú–æ—Å–∫–≤–∞\n4";
    document.getElementById('bulk-wrong').value = "–ü–∏—Ç–µ—Ä\n5";
    u();
};

function switchTab(id){ document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); document.querySelectorAll('.section').forEach(s=>s.classList.remove('active')); event.target.classList.add('active'); document.getElementById('tab-'+id).classList.add('active'); }
function applyLangPreset() { const p = langPresets[document.getElementById('lang-preset').value]; document.getElementById('tt').value = p.title; document.getElementById('td').value = p.desc; document.getElementById('tw').value = p.win; document.getElementById('tl').value = p.lose; document.getElementById('btn-start').value = p.btnStart; document.getElementById('btn-continue').value = p.btnContinue; document.getElementById('btn-retry').value = p.btnRetry; u(); }
function encodeImg(input, key) { const file = input.files[0]; if (file) { const reader = new FileReader(); reader.onload = function(e) { imgCache[key] = e.target.result; document.getElementById('img-' + key).value = "(–ó–∞–≥—Ä—É–∂–µ–Ω–æ)"; u(); }; reader.readAsDataURL(file); } }
function encodeAudio(input, key) { const file = input.files[0]; if (file) { const reader = new FileReader(); reader.onload = function(e) { audioCache[key] = e.target.result; document.getElementById('snd-' + key.replace('snd', '')).value = "(–ó–∞–≥—Ä—É–∂–µ–Ω–æ)"; u(); }; reader.readAsDataURL(file); } }
function clearCache(key) { if (key.startsWith('snd')) audioCache[key] = null; else imgCache[key] = null; }

function getCfg(){
    const questions = document.getElementById('bulk-questions').value.split('\n').filter(q => q.trim());
    const correct = document.getElementById('bulk-correct').value.split('\n').filter(c => c.trim());
    const wrong = document.getElementById('bulk-wrong').value.split('\n').filter(w => w.trim());
    const qs = [];
    for (let i = 0; i < questions.length; i++) {
        if (questions[i].trim() && correct[i]) {
            qs.push({ text: questions[i].trim(), correct: correct[i].split('|'), wrong: (wrong[i] || '???').split('|') });
        }
    }
    return {
        sp: document.getElementById('conf-speed').value, fr: document.getElementById('conf-freq').value, lives: document.getElementById('conf-lives').value,
        h: imgCache.hero || document.getElementById('img-hero').value, b: imgCache.bomb || document.getElementById('img-bomb').value, l: imgCache.life || document.getElementById('img-life').value,
        i1: imgCache.skin1 || document.getElementById('img-skin1').value, i2: imgCache.skin2 || document.getElementById('img-skin2').value, bsc: imgCache.bscore || document.getElementById('img-bonus-score').value,
        isz: document.getElementById('conf-size').value, hsz: document.getElementById('conf-hero-size').value, bsz: document.getElementById('conf-bomb-size').value, tpos: document.getElementById('conf-tpos').value,
        qs: qs, fn: document.getElementById('font-family').value, fq: document.getElementById('fs-q').value, fa: document.getElementById('fs-a').value,
        bc: document.getElementById('col-border').value, wbg: document.getElementById('col-win-bg').value, wtxt: document.getElementById('col-win-text').value, wglow: document.getElementById('win-glow').checked,
        p1: document.getElementById('col-p1').value, p2: document.getElementById('col-p2').value, qtxt: document.getElementById('col-question-text').value, qboxbg: document.getElementById('col-qbox-bg').value,
        cl: document.getElementById('col-lt').value, lb: document.getElementById('col-lb').value, itrans: document.getElementById('item-transparent').checked,
        tt: document.getElementById('tt').value, td: document.getElementById('td').value, tw: document.getElementById('tw').value, tl: document.getElementById('tl').value,
        btnStart: document.getElementById('btn-start').value, btnContinue: document.getElementById('btn-continue').value, btnRetry: document.getElementById('btn-retry').value,
        probBomb: document.getElementById('prob-bomb').value, probLife: document.getElementById('prob-life').value, probScore: document.getElementById('prob-score').value,
        mobileControls: document.getElementById('mobile-controls').checked,
        sndbomb: audioCache.sndbomb || document.getElementById('snd-bomb').value, sndcorrect: audioCache.sndcorrect || document.getElementById('snd-correct').value,
        sndwrong: audioCache.sndwrong || document.getElementById('snd-wrong').value, sndlife: audioCache.sndlife || document.getElementById('snd-life').value,
        sndbonus: audioCache.sndbonus || document.getElementById('snd-bonus').value, sndwin: audioCache.sndwin || document.getElementById('snd-win').value, sndlose: audioCache.sndlose || document.getElementById('snd-lose').value
    };
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø—Ä–µ–≤—å—é
function u(){
    // –û—Å—Ç–∞–≤–ª—è–µ–º –ø—É—Å—Ç–æ–π –¥–ª—è –ø—Ä–µ–≤—å—é –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ (–Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è –∑–∞–¥–∞—á–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏)
}

function gen(){
    alert('–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å" –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–Ω–ª–∞–π–Ω-—Å—Å—ã–ª–∫–∏.');
}

// === –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –ü–£–ë–õ–ò–ö–ê–¶–ò–ò ===
async function publishGame() {
    const config = getCfg();
    if (config.qs.length === 0) { alert('‚ö†Ô∏è –î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å!'); return; }

    const btn = document.querySelector('.btn-publish');
    const oldText = btn.innerText;
    btn.innerText = "‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞..."; btn.disabled = true;

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
    const gameId = 'game_' + Math.random().toString(36).substr(2, 9);
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞
    const payload = {
        id: gameId,
        folder: "data",
        data: config
    };

    try {
        const response = await fetch('https://nastyaiv3100-cyber/publish', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Publish-Key': 'super-secret-123'
            },
            body: JSON.stringify(payload)
        });

        if (response.ok) {
            // –§–æ—Ä–º–∏—Ä—É–µ–º iframe —Å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º ID
            const gameUrl = `https://nastyaiv3100-cyber.github.io/texts/game.html?id=${gameId}`; // –°—Å—ã–ª–∫–∞ –Ω–∞ –∏–≥—Ä—É (main.html)
            const iframeCode = `<iframe src="${gameUrl}" width="100%" height="600" frameborder="0" allowfullscreen></iframe>`;
            
            document.getElementById('final-code').value = iframeCode;
            document.querySelector('.code-modal h3').innerText = "‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!";
            document.getElementById('modal-code').style.display = 'flex';
        } else {
            alert('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + response.status);
        }
    } catch (e) {
        alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + e.message);
    } finally {
        btn.innerText = oldText; btn.disabled = false;
    }
}

function copy(){ const t=document.getElementById("final-code"); t.select(); document.execCommand("copy"); }
function resetAll() { if(confirm('–°–±—Ä–æ—Å–∏—Ç—å?')) location.reload(); }
</script>
</body>
</html>
